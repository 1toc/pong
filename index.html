<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro PONG</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #111;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #ddd;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none; /* スマホでのスクロール防止 */
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 600px;
            aspect-ratio: 4/3;
            background-color: #000;
            border: 4px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* CRTモニタ風のエフェクト（走査線） */
        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        /* CRT風の画面の輝き */
        .glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 50px rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 11;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20;
            cursor: pointer;
        }

        h1 {
            font-size: 4rem;
            margin: 0 0 20px 0;
            letter-spacing: 10px;
            text-transform: uppercase;
            text-shadow: 0 0 10px #fff;
        }

        p {
            font-size: 1.2rem;
            margin: 5px 0;
            text-align: center;
        }

        .blink {
            animation: blinker 1s linear infinite;
        }

        @keyframes blinker {
            50% { opacity: 0; }
        }

        @media (max-width: 600px) {
            h1 { font-size: 2.5rem; }
            p { font-size: 0.9rem; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="pongCanvas"></canvas>
    <div class="scanlines"></div>
    <div class="glow"></div>
    <div id="start-screen">
        <h1>PONG</h1>
        <p>CLICK TO START</p>
        <p class="blink" style="margin-top: 20px; font-size: 0.8rem;">Controls: Mouse / Touch / W & S Keys</p>
    </div>
</div>

<script>
    // --- 定数と設定 ---
    const canvas = document.getElementById('pongCanvas');
    const ctx = canvas.getContext('2d');
    const startScreen = document.getElementById('start-screen');

    // ゲームサイズ（内部解像度）
    const GAME_WIDTH = 800;
    const GAME_HEIGHT = 600;

    // ゲームオブジェクト
    const ball = {
        x: GAME_WIDTH / 2,
        y: GAME_HEIGHT / 2,
        radius: 10,
        speed: 7,
        velocityX: 5,
        velocityY: 5,
        color: "#FFF"
    };

    // プレイヤー（左）
    const user = {
        x: 0,
        y: (GAME_HEIGHT - 100) / 2,
        width: 15,
        height: 100,
        score: 0,
        color: "#FFF"
    };

    // AI（右）
    const com = {
        x: GAME_WIDTH - 15,
        y: (GAME_HEIGHT - 100) / 2,
        width: 15,
        height: 100,
        score: 0,
        color: "#FFF",
        speed: 0.09 // AIの反応速度 (0.0 - 1.0)
    };

    // ネット（中央線）
    const net = {
        x: (GAME_WIDTH - 4) / 2,
        y: 0,
        height: 20,
        width: 4,
        color: "#FFF"
    };

    // ゲーム状態
    let isGameRunning = false;
    let animationId;
    let audioCtx = null;

    // キャンバスのスケール調整
    function resizeCanvas() {
        // キャンバスの内部解像度を固定
        canvas.width = GAME_WIDTH;
        canvas.height = GAME_HEIGHT;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // --- 音声処理 (Web Audio API) ---
    function initAudio() {
        if (!audioCtx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        }
    }

    function playSound(type) {
        if (!audioCtx) return;
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }

        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        // レトロな矩形波
        oscillator.type = 'square';

        if (type === 'hit') {
            // 壁やパドルヒット音
            oscillator.frequency.value = 440; // A4
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'score') {
            // スコア音
            oscillator.frequency.value = 220; // A3
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- 描画関数 ---
    function drawRect(x, y, w, h, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
    }

    function drawArc(x, y, r, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        // レトロ感を出すため、完全な円ではなく正方形に近いボールにする場合もあるが、
        // ここでは仕様通り四角いドット描画にする
        ctx.fillRect(x - r, y - r, r * 2, r * 2); 
        ctx.closePath();
    }

    function drawNet() {
        for (let i = 0; i <= canvas.height; i += 30) {
            drawRect(net.x, net.y + i, net.width, net.height, net.color);
        }
    }

    function drawText(text, x, y) {
        ctx.fillStyle = "#FFF";
        ctx.font = "60px 'Courier New', Courier, monospace";
        ctx.fillText(text, x, y);
    }

    // --- ゲームロジック ---
    function resetBall() {
        ball.x = canvas.width / 2;
        ball.y = canvas.height / 2;
        ball.velocityX = -ball.velocityX; // 負けた方へサーブ
        ball.speed = 7;
    }

    function update() {
        // ボールの移動
        ball.x += ball.velocityX;
        ball.y += ball.velocityY;

        // AIの動き (簡易的な追従)
        let targetPos = ball.y - (com.height / 2);
        // 少しランダム性や遅れを持たせる
        com.y += (targetPos - com.y) * com.speed;

        // 上下の壁判定
        if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
            ball.velocityY = -ball.velocityY;
            playSound('hit');
        }

        // どちらのパドルに当たったか
        let player = (ball.x < canvas.width / 2) ? user : com;

        // 衝突判定
        if (collision(ball, player)) {
            playSound('hit');
            // ボールが当たる位置によって反射角を変える
            let collidePoint = (ball.y - (player.y + player.height / 2));
            collidePoint = collidePoint / (player.height / 2);

            let angleRad = (Math.PI / 4) * collidePoint;

            let direction = (ball.x < canvas.width / 2) ? 1 : -1;
            ball.velocityX = direction * ball.speed * Math.cos(angleRad);
            ball.velocityY = ball.speed * Math.sin(angleRad);

            // スピードアップ
            ball.speed += 0.2;
        }

        // スコア判定
        if (ball.x - ball.radius < 0) {
            com.score++;
            playSound('score');
            resetBall();
        } else if (ball.x + ball.radius > canvas.width) {
            user.score++;
            playSound('score');
            resetBall();
        }

        // パドルの画面外制限
        user.y = Math.max(0, Math.min(canvas.height - user.height, user.y));
        com.y = Math.max(0, Math.min(canvas.height - com.height, com.y));
    }

    function collision(b, p) {
        p.top = p.y;
        p.bottom = p.y + p.height;
        p.left = p.x;
        p.right = p.x + p.width;

        b.top = b.y - b.radius;
        b.bottom = b.y + b.radius;
        b.left = b.x - b.radius;
        b.right = b.x + b.radius;

        return p.left < b.right && p.top < b.bottom && p.right > b.left && p.bottom > b.top;
    }

    function render() {
        // 画面クリア
        drawRect(0, 0, canvas.width, canvas.height, "#000");

        drawText(user.score, canvas.width / 4, canvas.height / 5);
        drawText(com.score, 3 * canvas.width / 4, canvas.height / 5);

        drawNet();
        drawRect(user.x, user.y, user.width, user.height, user.color);
        drawRect(com.x, com.y, com.width, com.height, com.color);
        drawArc(ball.x, ball.y, ball.radius, ball.color);
    }

    function gameLoop() {
        update();
        render();
        if (isGameRunning) {
            animationId = requestAnimationFrame(gameLoop);
        }
    }

    // --- 入力制御 ---
    
    // マウス移動
    canvas.addEventListener("mousemove", getMousePos);
    
    function getMousePos(evt) {
        let rect = canvas.getBoundingClientRect();
        // キャンバス内のY座標を計算し、比率に合わせてスケーリング
        let scaleY = canvas.height / rect.height;
        user.y = (evt.clientY - rect.top) * scaleY - user.height / 2;
    }

    // タッチ操作（スマホ対応）
    canvas.addEventListener("touchmove", (evt) => {
        evt.preventDefault();
        let rect = canvas.getBoundingClientRect();
        let touch = evt.touches[0];
        let scaleY = canvas.height / rect.height;
        user.y = (touch.clientY - rect.top) * scaleY - user.height / 2;
    }, { passive: false });

    // キーボード操作
    window.addEventListener("keydown", (evt) => {
        const speed = 40;
        if (evt.key === "w" || evt.key === "ArrowUp") {
            user.y -= speed;
        } else if (evt.key === "s" || evt.key === "ArrowDown") {
            user.y += speed;
        }
    });

    // --- ゲーム開始制御 ---
    startScreen.addEventListener('click', () => {
        if (!isGameRunning) {
            initAudio(); // 音声コンテキストの開始（ユーザー操作必須）
            startScreen.style.display = 'none';
            isGameRunning = true;
            gameLoop();
        }
    });

    // 初期描画
    render();

</script>
</body>
</html>